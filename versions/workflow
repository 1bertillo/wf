#!/bin/bash

function exefastqc(){
	#Executing fastqc
	echo "INITIATING FASTQC:"
	../fastqc/fastqc/fastqc -o . $1
	#Decompressing file, copying and removing results
	echo "PROCESSING STATISTICS:"
	#We send the output to dev/null because we don't want it to show in the shell
	unzip $1_fastqc.zip > /dev/null
	#fastqc_data.txt is generated by the execution of FastQC and it contains the statistics of the analysis performed.
	cp $1_fastqc/fastqc_data.txt .
	rm -R $1_fastqc
	rm $1_fastqc.html $1_fastqc.zip
	#We show the result of the FastQC execution by grepping the results
	cat fastqc_data.txt | grep pass
	cat fastqc_data.txt | grep fail
	cat fastqc_data.txt | grep warn
	echo "------------------------------------------------------------------------"
}

function executadapt(){
	#Executing cutadapt
	echo "INITIATING CUTADAPT:"
	../cutadapt/cutadapt-install/build/scripts-2.6/cutadapt -a $2 $1 > $1.output.fq
	echo "------------------------------------------------------------------------"
}

#Main
if ! [ $# -eq 1 ];then
	echo "Usage: $0 [input.fq]"
	exit 1
fi
chain="AACCGGTT"
appname="workflow"
repocutadapt="https://raw.githubusercontent.com/1bertillo/cutadapt/master/metadata/manifest.yml"
repofastqc="https://raw.githubusercontent.com/1bertillo/fastqc/master/metadata/manifest.yml"

#Creating an application with python-2.7
#rhc app-create $appname python-2.7
#Launching FastQC cartridge
rhc cartridge-add $repofastqc -a $appname
exefastqc $1

#Launching CUTADAPT cartridge
rhc cartridge-add $repocutadapt -a $appname
executadapt $1 $chain

#Executing FastQC with input as the output of the cutadapt execution
exefastqc $1.output.fq

#Removing the application after the execution
rhc app-delete $appname
